"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var bucketHostname_1 = require("./bucketHostname");
var protocol_http_1 = require("@aws-sdk/protocol-http");
function bucketEndpointMiddleware(options) {
    var _this = this;
    return function (next) { return function (args) { return tslib_1.__awaiter(_this, void 0, void 0, function () {
        var bucketName, replaceBucketInPath, request, _a, hostname, bucketEndpoint;
        return tslib_1.__generator(this, function (_b) {
            bucketName = args.input.Bucket;
            replaceBucketInPath = options.bucketEndpoint;
            request = args.request;
            if (protocol_http_1.HttpRequest.isInstance(request)) {
                if (options.bucketEndpoint) {
                    request.hostname = bucketName;
                }
                else {
                    _a = bucketHostname_1.bucketHostname({
                        bucketName: bucketName,
                        baseHostname: request.hostname,
                        accelerateEndpoint: options.useAccelerateEndpoint,
                        dualstackEndpoint: options.useDualstackEndpoint,
                        pathStyleEndpoint: options.forcePathStyle,
                        tlsCompatible: request.protocol === "https:"
                    }), hostname = _a.hostname, bucketEndpoint = _a.bucketEndpoint;
                    request.hostname = hostname;
                    replaceBucketInPath = bucketEndpoint;
                }
                if (replaceBucketInPath) {
                    request.path = request.path.replace(/^(\/)?[^\/]+/, "");
                    if (request.path === "") {
                        request.path = "/";
                    }
                }
            }
            return [2 /*return*/, next(tslib_1.__assign(tslib_1.__assign({}, args), { request: request }))];
        });
    }); }; };
}
exports.bucketEndpointMiddleware = bucketEndpointMiddleware;
exports.bucketEndpointMiddlewareOptions = {
    step: "build",
    tags: ["BUCKET_ENDPOINT"],
    name: "bucketEndpointMiddleware",
    relation: "before",
    toMiddleware: "hostHeaderMiddleware"
};
exports.getBucketEndpointPlugin = function (options) { return ({
    applyToStack: function (clientStack) {
        clientStack.addRelativeTo(bucketEndpointMiddleware(options), exports.bucketEndpointMiddlewareOptions);
    }
}); };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0RW5kcG9pbnRNaWRkbGV3YXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2J1Y2tldEVuZHBvaW50TWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtREFBa0Q7QUFZbEQsd0RBQXFEO0FBRXJELFNBQWdCLHdCQUF3QixDQUN0QyxPQUFxQztJQUR2QyxpQkFzQ0M7SUFuQ0MsT0FBTyxVQUNMLElBQStCLElBQ0QsT0FBQSxVQUM5QixJQUFnQzs7O1lBRWhCLFVBQVUsR0FBSyxJQUFJLENBQUMsS0FBSyxPQUFmLENBQWdCO1lBQ3RDLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUM7WUFDN0MsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDM0IsSUFBSSwyQkFBVyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDbkMsSUFBSSxPQUFPLENBQUMsY0FBYyxFQUFFO29CQUMxQixPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztpQkFDL0I7cUJBQU07b0JBQ0MsS0FBK0IsK0JBQWMsQ0FBQzt3QkFDbEQsVUFBVSxZQUFBO3dCQUNWLFlBQVksRUFBRSxPQUFPLENBQUMsUUFBUTt3QkFDOUIsa0JBQWtCLEVBQUUsT0FBTyxDQUFDLHFCQUFxQjt3QkFDakQsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLG9CQUFvQjt3QkFDL0MsaUJBQWlCLEVBQUUsT0FBTyxDQUFDLGNBQWM7d0JBQ3pDLGFBQWEsRUFBRSxPQUFPLENBQUMsUUFBUSxLQUFLLFFBQVE7cUJBQzdDLENBQUMsRUFQTSxRQUFRLGNBQUEsRUFBRSxjQUFjLG9CQUFBLENBTzdCO29CQUVILE9BQU8sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO29CQUM1QixtQkFBbUIsR0FBRyxjQUFjLENBQUM7aUJBQ3RDO2dCQUVELElBQUksbUJBQW1CLEVBQUU7b0JBQ3ZCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUN4RCxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssRUFBRSxFQUFFO3dCQUN2QixPQUFPLENBQUMsSUFBSSxHQUFHLEdBQUcsQ0FBQztxQkFDcEI7aUJBQ0Y7YUFDRjtZQUVELHNCQUFPLElBQUksdUNBQU0sSUFBSSxLQUFFLE9BQU8sU0FBQSxJQUFHLEVBQUM7O1NBQ25DLEVBaEMrQixDQWdDL0IsQ0FBQztBQUNKLENBQUM7QUF0Q0QsNERBc0NDO0FBRVksUUFBQSwrQkFBK0IsR0FDYjtJQUM3QixJQUFJLEVBQUUsT0FBTztJQUNiLElBQUksRUFBRSxDQUFDLGlCQUFpQixDQUFDO0lBQ3pCLElBQUksRUFBRSwwQkFBMEI7SUFDaEMsUUFBUSxFQUFFLFFBQVE7SUFDbEIsWUFBWSxFQUFFLHNCQUFzQjtDQUNyQyxDQUFDO0FBRVcsUUFBQSx1QkFBdUIsR0FBRyxVQUNyQyxPQUFxQyxJQUNiLE9BQUEsQ0FBQztJQUN6QixZQUFZLEVBQUUsVUFBQSxXQUFXO1FBQ3ZCLFdBQVcsQ0FBQyxhQUFhLENBQ3ZCLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxFQUNqQyx1Q0FBK0IsQ0FDaEMsQ0FBQztJQUNKLENBQUM7Q0FDRixDQUFDLEVBUHdCLENBT3hCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBidWNrZXRIb3N0bmFtZSB9IGZyb20gXCIuL2J1Y2tldEhvc3RuYW1lXCI7XG5pbXBvcnQgeyBCdWNrZXRFbmRwb2ludFJlc29sdmVkQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlndXJhdGlvbnNcIjtcbmltcG9ydCB7XG4gIEJ1aWxkSGFuZGxlcixcbiAgQnVpbGRIYW5kbGVyQXJndW1lbnRzLFxuICBCdWlsZEhhbmRsZXJPcHRpb25zLFxuICBCdWlsZEhhbmRsZXJPdXRwdXQsXG4gIEJ1aWxkTWlkZGxld2FyZSxcbiAgTWV0YWRhdGFCZWFyZXIsXG4gIFBsdWdnYWJsZSxcbiAgUmVsYXRpdmVMb2NhdGlvblxufSBmcm9tIFwiQGF3cy1zZGsvdHlwZXNcIjtcbmltcG9ydCB7IEh0dHBSZXF1ZXN0IH0gZnJvbSBcIkBhd3Mtc2RrL3Byb3RvY29sLWh0dHBcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGJ1Y2tldEVuZHBvaW50TWlkZGxld2FyZShcbiAgb3B0aW9uczogQnVja2V0RW5kcG9pbnRSZXNvbHZlZENvbmZpZ1xuKTogQnVpbGRNaWRkbGV3YXJlPGFueSwgYW55PiB7XG4gIHJldHVybiA8T3V0cHV0IGV4dGVuZHMgTWV0YWRhdGFCZWFyZXI+KFxuICAgIG5leHQ6IEJ1aWxkSGFuZGxlcjxhbnksIE91dHB1dD5cbiAgKTogQnVpbGRIYW5kbGVyPGFueSwgT3V0cHV0PiA9PiBhc3luYyAoXG4gICAgYXJnczogQnVpbGRIYW5kbGVyQXJndW1lbnRzPGFueT5cbiAgKTogUHJvbWlzZTxCdWlsZEhhbmRsZXJPdXRwdXQ8T3V0cHV0Pj4gPT4ge1xuICAgIGNvbnN0IHsgQnVja2V0OiBidWNrZXROYW1lIH0gPSBhcmdzLmlucHV0O1xuICAgIGxldCByZXBsYWNlQnVja2V0SW5QYXRoID0gb3B0aW9ucy5idWNrZXRFbmRwb2ludDtcbiAgICBsZXQgcmVxdWVzdCA9IGFyZ3MucmVxdWVzdDtcbiAgICBpZiAoSHR0cFJlcXVlc3QuaXNJbnN0YW5jZShyZXF1ZXN0KSkge1xuICAgICAgaWYgKG9wdGlvbnMuYnVja2V0RW5kcG9pbnQpIHtcbiAgICAgICAgcmVxdWVzdC5ob3N0bmFtZSA9IGJ1Y2tldE5hbWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB7IGhvc3RuYW1lLCBidWNrZXRFbmRwb2ludCB9ID0gYnVja2V0SG9zdG5hbWUoe1xuICAgICAgICAgIGJ1Y2tldE5hbWUsXG4gICAgICAgICAgYmFzZUhvc3RuYW1lOiByZXF1ZXN0Lmhvc3RuYW1lLFxuICAgICAgICAgIGFjY2VsZXJhdGVFbmRwb2ludDogb3B0aW9ucy51c2VBY2NlbGVyYXRlRW5kcG9pbnQsXG4gICAgICAgICAgZHVhbHN0YWNrRW5kcG9pbnQ6IG9wdGlvbnMudXNlRHVhbHN0YWNrRW5kcG9pbnQsXG4gICAgICAgICAgcGF0aFN0eWxlRW5kcG9pbnQ6IG9wdGlvbnMuZm9yY2VQYXRoU3R5bGUsXG4gICAgICAgICAgdGxzQ29tcGF0aWJsZTogcmVxdWVzdC5wcm90b2NvbCA9PT0gXCJodHRwczpcIlxuICAgICAgICB9KTtcblxuICAgICAgICByZXF1ZXN0Lmhvc3RuYW1lID0gaG9zdG5hbWU7XG4gICAgICAgIHJlcGxhY2VCdWNrZXRJblBhdGggPSBidWNrZXRFbmRwb2ludDtcbiAgICAgIH1cblxuICAgICAgaWYgKHJlcGxhY2VCdWNrZXRJblBhdGgpIHtcbiAgICAgICAgcmVxdWVzdC5wYXRoID0gcmVxdWVzdC5wYXRoLnJlcGxhY2UoL14oXFwvKT9bXlxcL10rLywgXCJcIik7XG4gICAgICAgIGlmIChyZXF1ZXN0LnBhdGggPT09IFwiXCIpIHtcbiAgICAgICAgICByZXF1ZXN0LnBhdGggPSBcIi9cIjtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXh0KHsgLi4uYXJncywgcmVxdWVzdCB9KTtcbiAgfTtcbn1cblxuZXhwb3J0IGNvbnN0IGJ1Y2tldEVuZHBvaW50TWlkZGxld2FyZU9wdGlvbnM6IEJ1aWxkSGFuZGxlck9wdGlvbnMgJlxuICBSZWxhdGl2ZUxvY2F0aW9uPGFueSwgYW55PiA9IHtcbiAgc3RlcDogXCJidWlsZFwiLFxuICB0YWdzOiBbXCJCVUNLRVRfRU5EUE9JTlRcIl0sXG4gIG5hbWU6IFwiYnVja2V0RW5kcG9pbnRNaWRkbGV3YXJlXCIsXG4gIHJlbGF0aW9uOiBcImJlZm9yZVwiLFxuICB0b01pZGRsZXdhcmU6IFwiaG9zdEhlYWRlck1pZGRsZXdhcmVcIlxufTtcblxuZXhwb3J0IGNvbnN0IGdldEJ1Y2tldEVuZHBvaW50UGx1Z2luID0gKFxuICBvcHRpb25zOiBCdWNrZXRFbmRwb2ludFJlc29sdmVkQ29uZmlnXG4pOiBQbHVnZ2FibGU8YW55LCBhbnk+ID0+ICh7XG4gIGFwcGx5VG9TdGFjazogY2xpZW50U3RhY2sgPT4ge1xuICAgIGNsaWVudFN0YWNrLmFkZFJlbGF0aXZlVG8oXG4gICAgICBidWNrZXRFbmRwb2ludE1pZGRsZXdhcmUob3B0aW9ucyksXG4gICAgICBidWNrZXRFbmRwb2ludE1pZGRsZXdhcmVPcHRpb25zXG4gICAgKTtcbiAgfVxufSk7XG4iXX0=